---
title: "NHS 2020: Forecasting multiple seasonality"
subtitle: "Multiple seasonal forecasting with fable"
author: "Mitchell O'Hara-Wild"
date: '25/11/2020'
output:
  xaringan::moon_reader:
    chakra: ./libs/remark-latest.min.js
    css: ["././libs/slides.css", "././libs/animate.css"]
    lib_dir: ./libs
    seal: false
    anchor_sections: false
    nature:
      highlightStyle: github
      ratio: '16:9'
      highlightLines: true
      countIncrementalSlides: false 
      beforeInit: ["./libs/jquery/jquery.min.js", "./libs/slides.js"]
---
class: inverse
background-image: linear-gradient(to right, rgba(150, 150, 150, .1), rgba(150, 150, 150, .4)), url("resources/hourglass.jpg")
background-size: cover

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE, width = 120)

library(tidyverse)
library(knitr)
library(kableExtra)
library(fontawesome)
library(lubridate)
library(htmltools)

library(tsibble)
library(fasster)
library(fable)

opts_chunk$set(
  echo = FALSE, warning = FALSE, message = FALSE, comment = "#>",
  fig.path = 'figure/', cache.path = 'cache/', fig.align = 'center',
  fig.width = 12, fig.height = 4, fig.show = 'hold',
  cache = TRUE, external = TRUE, dev = 'svglite', dev.args = list(bg = "transparent")
)

mp4_vid <- function(src){
  HTML(
    paste0(
      '<video autoplay>
        <source src="', src, '" type="video/mp4">
      </video>'
    )
  )
}

hook_output <- knit_hooks$get("output")
knit_hooks$set(output = function(x, options) {
   lines <- options$output.lines
   if (is.null(lines)) {
     return(hook_output(x, options))  # pass to default hook
   }
   x <- unlist(strsplit(x, "\n"))
   more <- "..."
   if (length(lines)==1) {        # first n lines
     if (length(x) > lines) {
       # truncate the output, but add ....
       x <- c(head(x, lines), more)
     }
   } else {
     x <- c(more, x[lines], more)
   }
   # paste these lines together
   x <- paste(c(x, ""), collapse = "\n")
   hook_output(x, options)
 })

theme_set(
  theme_grey(base_size = 16) +
  theme(
    legend.position = "bottom",
    plot.background = element_rect(fill = "transparent"),
    legend.background = element_rect(fill = "transparent")
  )
)
```


```{css, echo=FALSE}
/* custom.css */
.left-code {
  color: #777;
  width: 40%;
  height: 92%;
  float: left;
}
.right-plot {
  width: 58%;
  float: right;
  padding-left: 1%;
}
```


.title[fable]
.sticker-float[![fable](resources/fable.svg)]

## Forecasting with multiple seasonality

.bottom[
### Mitchell O'Hara-Wild (`r fa("twitter", fill="#1da1f2")`[@mitchoharawild](https://twitter.com/mitchoharawild))
### 25 November 2020
### Slides @ [slides.mitchelloharawild.com/nhs2020](https://slides.mitchelloharawild.com/nhs2020)
]

---
class: inverse
background-image: linear-gradient(to right, rgba(150, 150, 150, .1), rgba(150, 150, 150, .4)), url("resources/timezone.jpg")
background-size: cover

.title[Hello!]

---
class: center
background-image: linear-gradient(to right, rgba(255, 255, 255, .1), rgba(150, 150, 150, .1)), url("resources/season.jpg")
background-size: cover

## Understanding multiple seasonality

---
background-image: linear-gradient(to right, rgba(255, 255, 255, .1), rgba(150, 150, 150, .1)), url("resources/season.jpg")
background-size: cover

.center[
## What is seasonality?
]

--

> A consistent pattern which repeats over a fixed period of time.

--

.box-12.opaque[
```{r ped-seasonality}
pedestrian %>% 
  filter(Sensor == "Southern Cross Station",
         between(Date, parse_date("2015-04-13"), parse_date("2015-04-17"))) %>% 
  autoplot(Count) + 
  scale_x_datetime(date_labels = "%A", date_breaks = "1 day") +
  labs(y = "Number of pedestrians", x = "Time", title = "Pedestrian traffic at Southern Cross Station (Victoria, Australia)")
```
]


---
background-image: linear-gradient(to right, rgba(255, 255, 255, .1), rgba(150, 150, 150, .1)), url("resources/season.jpg")
background-size: cover

.center[
## What is *multiple* seasonality?
]

--

> Two or more seasonal patterns.

--

.box-12.opaque[
```{r ped-multi-seasonality}
pedestrian %>% 
  filter(Sensor == "Southern Cross Station",
         yearmonth(Date) == yearmonth("2015 Apr")) %>% 
  autoplot(Count) + 
  scale_x_datetime(date_labels = "%d %b %Y", date_breaks = "5 days") +
  labs(y = "Number of pedestrians", x = "Time", title = "Pedestrian traffic at Southern Cross Station (Victoria, Australia)")
```
]

---

## Capturing (multiple) seasonal patterns

1. Seasonal dummies
1. Fourier terms
1. Lag terms
1. Exogenous regressors

---

## Models with multiple seasonal forecasting capabilities

1. TSLM
1. GAM
1. Prophet
1. FASSTER
1. DSHW
1. TBATS
1. STL decomposition forecasting


---

## Models with multiple seasonal forecasting capabilities

<br>
<table class="table">
  <thead>
    <tr>
      <th>Model</th>
      <th>Flexible</th>
      <th>Speed</th>
      <th>Accuracy</th>
      <th>Exogenous Regressors</th>
      <th>Decompose Components</th>
      <th>Evolving Terms</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Regression<br>(TSLM, GAM, Prophet)</td>
      <td class="success">Yes</td>
      <td class="success">Fast</td>
      <td class="warning">Okay</td>
      <td class="success">Yes</td>
      <td class="warning">Depends</td>
      <td class="danger">No</td>
    </tr>
    <tr>
      <td>State&nbspSpace<br>(DSHW, TBATS, FASSTER)</td>
      <td class="danger">No</td>
      <td class="danger">Slow</td>
      <td class="warning">Okay</td>
      <td class="warning">Depends</td>
      <td class="success">Yes</td>
      <td class="success">Yes</td>
    </tr>
    <tr>
      <td>Decomposition<br>(STL + ???)</td>
      <td class="warning">Depends</td>
      <td class="warning">Moderate</td>
      <td class="warning">Okay</td>
      <td class="warning">Depends</td>
      <td class="success">Yes</td>
      <td class="warning">Depends</td>
    </tr>
  </tbody>
</table>

.footnote[(this table is a *massive* generalisation)]
---
class: center

## Forecasting multiple seasonality in R

.sticker[![fable](resources/fable.svg)]

--

.animated.fadeIn[
.sticker[![tsibble](resources/tsibble.svg)]
.sticker[![tsibbledata](resources/tsibbledata.svg)]
.sticker[![feasts](resources/feasts.svg)]

## [tidyverts.org](http://www.tidyverts.org)
]

---
class: top

```{r}
htmltools::tags$iframe(src = "https://otexts.com/fpp3/a-tidy-forecasting-workflow.html", 
                       width = "100%", height = "640px")
```

---
class: inverse, center
background-image: linear-gradient(to right, rgba(50, 50, 50, .5), rgba(50, 50, 50, .5)), url("resources/disk.jpg")
background-size: cover

.title[Tidy]

<hr>

## Data preparation

---
class: top

# Hospital admissions

```{r, echo = TRUE}
fs::dir_tree("~/github/webinar-msc-nhs/")
```

.footnote[*https://github.com/bahmanrostamitabar/webinar-msc-nhs/*]

---
class: top

# Admissions event data

```{r admission-raw, echo = TRUE}
admissions <- read_csv(
  file = "~/github/webinar-msc-nhs/data/ae_uk.csv",
  col_types = cols(arrival_time=col_datetime(format = "%d/%m/%Y %H:%M"))
) %>%
  select(-ID) # ID is a redundant row identifier 
print(admissions)
```

---
class: top

# Holiday data

```{r holiday-raw, echo = TRUE}
holidays <- read_csv(
  file = "~/github/webinar-msc-nhs/data/holiday.csv",
  col_types = cols(date=col_date(format = "%d/%m/%Y"))
) %>% 
  filter(!is.na(date)) # Some extra empty rows exist that need removing
print(holidays)
```

---
class: top

# Temperature data

```{r temperature-raw, echo = TRUE}
temperatures <- read_csv(
  file = "~/github/webinar-msc-nhs/data/temp.csv",
  col_types = cols(date=col_date(format = "%d/%m/%Y"))
)

print(temperatures)
```

---

class: top

.sticker-float[![tsibble](resources/tsibble.svg)]

# Tidy temporal data structures

```{r}
htmltools::tags$iframe(src = "https://thesis.earo.me/3-3-sec-semantics.html", 
                       width = "100%", height = "500px")
```

---
class: top

.sticker-float[![tsibble](resources/tsibble.svg)]

# Tidy temperature data

Identify the index, key and measurement variables:

```{r temperature-qa, echo = TRUE, eval = FALSE}
temperatures <- as_tsibble(temperatures, 
           index = ???, key = ???) #<<
```

```{r}
temperatures
```

---
class: top

.sticker-float[![tsibble](resources/tsibble.svg)]

# Tidy temperature data

Identify the index, key and measurement variables:

```{r temperature-tsbl, echo = TRUE, eval = TRUE}
temperatures <- as_tsibble(temperatures, 
           index = date, key = NULL) #<<
```

```{r}
temperatures
```

---
class: top

.sticker-float[![tsibble](resources/tsibble.svg)]

# Tidy holiday data

Identify the index, key and measurement variables:

```{r holiday-qa, echo = TRUE, eval = FALSE}
holidays <- as_tsibble(holidays, 
           index = ???, key = ???) #<<
```

```{r}
holidays
```

---
class: top

.sticker-float[![tsibble](resources/tsibble.svg)]

# Tidy holiday data

Identify the index, key and measurement variables:

```{r holiday-tsbl, echo = TRUE, eval = TRUE}
holidays <- as_tsibble(holidays, 
           index = date, key = NULL) #<<
```

```{r}
holidays
```

---
class: top

.sticker-float[![tsibble](resources/tsibble.svg)]

# Tidy admissions data

Identify the index, key and measurement variables:

```{r admission-qa, echo = TRUE, eval = FALSE}
admissions <- as_tsibble(admissions, 
           index = ???, key = ???) #<<
```

```{r}
admissions
```

---
class: top

.sticker-float[![tsibble](resources/tsibble.svg)]

# Tidy admissions data

Identify the index, key and measurement variables:

```{r admission-bad, echo = TRUE, eval = TRUE, error = TRUE}
admissions <- as_tsibble(admissions, 
           index = arrival_time, key = c(gender, type_injury)) #<<
```

--

```{r admission-duplicates, echo = TRUE}
duplicates(admissions, index = arrival_time, key = c(gender, type_injury))
```

---
class: top

.sticker-float[![tsibble](resources/tsibble.svg)]

# Tidy admissions data

Identify the index, key and measurement variables:

```{r admission-tsbl, echo = TRUE, eval = TRUE, error = TRUE}
admissions <- admissions %>% 
  count(gender, type_injury, arrival_time, name = "arrivals") %>% #<<
  as_tsibble(index = arrival_time, key = c(gender, type_injury))
```

```{r}
admissions
```

---
class: inverse, top
background-image: linear-gradient(to right, rgba(150, 150, 150, .1), rgba(150, 150, 150, .4)), url("resources/hourglass.jpg")
background-size: cover

.sticker-float[![fable](resources/fable.svg)]

.title[Thanks! `r fa("comments", fill = "white")`]

.larger[
`r fa("globe", fill = "white")` Learn more: [fable.tidyverts.org](https://fable.tidyverts.org/)

`r fa("chart-line", fill = "white")` Keep updated: [tidyverts.org](http://www.tidyverts.org)

`r fa("desktop", fill = "white")` Review slides: [slides.mitchelloharawild.com/nhs2020](https://slides.mitchelloharawild.com/nhs2020)

`r fa("twitter", fill = "white")` Say hello: [@mitchoharawild](twitter.com/mitchoharawild/)

<br>

.bottom[This work is licensed as `r fa("creative-commons", fill="white")` BY-NC 4.0.]
]
